<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Jogo 3D - Pointer Lock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; background:#111; }
    #overlay {
      position: fixed; inset: 0; display: grid; place-items: center; 
      background: radial-gradient(ellipse at center, rgba(0,0,0,.65), rgba(0,0,0,.85));
      color: #fff; text-align: center; gap: 14px; padding: 24px;
      transition: opacity .2s ease;
    }
    #overlay.hidden { opacity: 0; pointer-events: none; }
    .icon-button {
      width: 96px; height: 96px; border-radius: 999px; border: 2px solid #39f;
      display: grid; place-items: center; cursor: pointer; user-select: none;
      box-shadow: 0 6px 24px rgba(0,0,0,.35), inset 0 0 24px rgba(51,153,255,.25);
      transition: transform .1s ease, box-shadow .2s ease, border-color .2s ease;
      background: linear-gradient(180deg, #0b2540, #081a2b);
    }
    .icon-button:hover { transform: translateY(-2px); border-color:#6bf; }
    .icon-button:active { transform: translateY(0); }
    .mouse-icon {
      font-size: 42px; line-height: 1;
      filter: drop-shadow(0 2px 8px rgba(51,153,255,.5));
    }
    .hint { font: 14px/1.4 system-ui, sans-serif; opacity: .9; }
    .hint kbd {
      background:#222; border:1px solid #444; padding:2px 6px; border-radius:4px; font-weight:600;
    }
    #stats { position: fixed; top: 8px; left: 8px; color:#9bd; font: 12px/1 system-ui; opacity:.8 }
  </style>
</head>
<body>
  <div id="overlay">
    <div class="icon-button" id="lockBtn" title="Clique para capturar o mouse">
      <div class="mouse-icon">üñ±Ô∏è</div>
    </div>
    <div class="hint">
      Clique no bot√£o para capturar o mouse.<br/>
      Use <kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> para andar ‚Ä¢ <kbd>Esc</kbd> para sair
    </div>
  </div>
  <div id="stats"></div>
  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.159.0/build/three.module.js";
    import { PointerLockControls } from "https://unpkg.com/three@0.159.0/examples/jsm/controls/PointerLockControls.js";

    // --- B√°sico da cena ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0f1320);

    const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Luzes
    const hemi = new THREE.HemisphereLight(0xbfdfff, 0x202020, 0.75);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(10, 20, 10);
    dir.castShadow = true;
    dir.shadow.mapSize.set(2048, 2048);
    scene.add(dir);

    // Ch√£o
    const groundGeo = new THREE.PlaneGeometry(500, 500);
    const groundMat = new THREE.MeshPhongMaterial({ color: 0x2a2f3a });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Objetos de refer√™ncia
    const boxGeo = new THREE.BoxGeometry(2, 2, 2);
    const cols = [0x4cc9f0, 0x4895ef, 0x4361ee, 0x3f37c9, 0x560bad];
    for (let i = 0; i < 60; i++) {
      const mat = new THREE.MeshStandardMaterial({ color: cols[i % cols.length], roughness: .6, metalness: .15 });
      const box = new THREE.Mesh(boxGeo, mat);
      box.position.set((Math.random()-0.5)*120, 1, (Math.random()-0.5)*120);
      box.castShadow = true;
      box.receiveShadow = true;
      scene.add(box);
    }

    // Grade para orienta√ß√£o
    const grid = new THREE.GridHelper(200, 40, 0x335, 0x223);
    grid.position.y = 0.01;
    scene.add(grid);

    // --- Pointer Lock + controles de c√¢mera (FPS) ---
    const controls = new PointerLockControls(camera, renderer.domElement);
    scene.add(controls.getObject()); // o objeto "jogador" que carrega a c√¢mera

    // posi√ß√£o inicial
    controls.getObject().position.set(0, 2, 8);

    // Overlay / bot√£o para capturar mouse
    const overlay = document.getElementById('overlay');
    const lockBtn = document.getElementById('lockBtn');

    lockBtn.addEventListener('click', () => {
      controls.lock(); // solicita pointer lock (o navegador pedir√° permiss√£o)
    });

    controls.addEventListener('lock', () => overlay.classList.add('hidden'));
    controls.addEventListener('unlock', () => overlay.classList.remove('hidden'));

    // --- Movimento WASD com acelera√ß√£o simples ---
    const keys = { w:false, a:false, s:false, d:false };
    const velocity = new THREE.Vector3();
    const direction = new THREE.Vector3();

    const onKey = (e, down) => {
      switch (e.code) {
        case 'KeyW': keys.w = down; break;
        case 'KeyA': keys.a = down; break;
        case 'KeyS': keys.s = down; break;
        case 'KeyD': keys.d = down; break;
      }
    };
    addEventListener('keydown', e => onKey(e, true));
    addEventListener('keyup',   e => onKey(e, false));

    // Evita scroll com espa√ßo/teclas quando travado
    addEventListener('keydown', e => {
      if (controls.isLocked && ['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) {
        e.preventDefault();
      }
    }, { passive:false });

    // --- Loop ---
    const clock = new THREE.Clock();
    const statsEl = document.getElementById('stats');

    function animate() {
      requestAnimationFrame(animate);
      const delta = Math.min(clock.getDelta(), 0.05);

      // F√≠sica simples de movimento
      const speed = 25.0;      // velocidade "m√°xima"
      const damping = 10.0;    // amortecimento

      velocity.x -= velocity.x * damping * delta;
      velocity.z -= velocity.z * damping * delta;

      direction.set(0,0,0);
      if (keys.w) direction.z -= 1;
      if (keys.s) direction.z += 1;
      if (keys.a) direction.x -= 1;
      if (keys.d) direction.x += 1;
      direction.normalize();

      if (controls.isLocked) {
        if (direction.lengthSq() > 0) {
          // aplica na base da orienta√ß√£o atual
          const forward = new THREE.Vector3();
          controls.getDirection(forward); // dire√ß√£o olhando (unit√°ria)
          forward.y = 0; forward.normalize();

          const right = new THREE.Vector3().crossVectors(forward, new THREE.Vector3(0,1,0)).negate();

          velocity.addScaledVector(forward,  speed * delta * -direction.z);
          velocity.addScaledVector(right,    speed * delta *  direction.x);
        }

        controls.getObject().position.addScaledVector(velocity, delta);
        // mant√©m ‚Äúp√©s‚Äù acima do ch√£o
        controls.getObject().position.y = 2;
      }

      renderer.render(scene, camera);

      // debug simples
      statsEl.textContent = `FPS: ${(1/delta|0)}  |  Pos: ${controls.getObject().position.x.toFixed(1)}, ${controls.getObject().position.y.toFixed(1)}, ${controls.getObject().position.z.toFixed(1)}`;
    }
    animate();

    // Resize
    addEventListener('resize', () => {
      camera.aspect = innerWidth / innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });
  </script>
</body>
</html>
